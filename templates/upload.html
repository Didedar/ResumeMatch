{% extends "base.html" %}

{% block title %}
    Upload
{% endblock %}

{% block body %}
<main>
    <style>
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary);
            color: white;
            text-decoration: none;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            font-weight: 500;
            border: none;
            cursor: pointer;
        }
    </style>

    <form class="resume-upload-form" id="uploadForm" enctype="multipart/form-data" onsubmit="return false;">
        <h2 class="resume-title">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–µ —Ä–µ–∑—é–º–µ</h2>
        <p class="resume-subtitle">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: PDF, DOC, DOCX(–¥–æ 5MB)</p>
        <div class="upload-zone">
            <div class="upload-icon">üìÑ</div>
            <p class="upload-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
            <input type="file" id="resume" name="resume" accept=".pdf, .doc, .docx" style="display: none;" required>
        </div>
        <button class="btn upload-btn" type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—é–º–µ</button>
    </form>

    {% if vacancies %}
        <section class="jobs-section">
            <div class="jobs-header">
                <h2 class="jobs-found">–ü–æ–¥—Ö–æ–¥—è—â–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏:</h2>
                <div>
                    <div id="filter-root" class="filter-container"></div>
                </div>
            </div>
            {% for vacancy in vacancies %}
<div class="job-card">
    <div class="job-info">
        <h3><a href="{{ vacancy['url'] }}" target="_blank">{{ vacancy['title'] }}</a></h3>
        <div class="company-info">
            <div class="company-logo">V</div>
            <span>
                <p>{{ vacancy['snippet'] }}</p>
            </span>
        </div>
        <div class="job-tags">
            {% if vacancy['salary'] %}
                <span class="tag tag-salary">
                    {% if vacancy['salary']['from'] %}
                        –æ—Ç {{ vacancy['salary']['from'] }} ‚ÇΩ
                    {% endif %}
                    {% if vacancy['salary']['to'] %}
                        –¥–æ {{ vacancy['salary']['to'] }} ‚ÇΩ
                    {% endif %}
                </span>
            {% else %}
                <span class="tag tag-salary">–ó–∞—Ä–ø–ª–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞</span>
            {% endif %}
            <span class="tag tag-type">{{ vacancy['employment_type'] }}</span>
        </div>
    </div>
    <div class="similarity-score">
        <strong>–°—Ö–æ–∂–µ—Å—Ç—å: </strong> ${similarity ? similarity.toFixed(2) + '%' : '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'}
    </div>  <-- –ó–ê–ö–†–´–í–ê–Æ–©–ò–ô </div> –î–û–ë–ê–í–õ–ï–ù –ó–î–ï–°–¨!
    <a href="{{ vacancy['url'] }}" class="btn">–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è</a>  <-- –û–î–ù–ê –ö–ù–û–ü–ö–ê "–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è" –ü–û–°–õ–ï similarity-score
</div>
{% endfor %}
        </section>
    {% endif %}
</main>

<script>
    const uploadZone = document.querySelector('.upload-zone');
    const fileInput = document.querySelector('#resume');
    const uploadForm = document.getElementById('uploadForm');
    const uploadText = document.querySelector('.upload-text');

    const fileInfoHTML = `
        <div class="file-info">
            <span class="file-name"></span>
            <span class="remove-file">‚úï</span>
        </div>
    `;
    uploadZone.insertAdjacentHTML('beforeend', fileInfoHTML);

    const fileInfo = document.querySelector('.file-info');
    const fileName = document.querySelector('.file-name');
    const removeFileBtn = document.querySelector('.remove-file');

    function updateFileInfo(file) {
        if (file) {
            fileName.textContent = file.name;
            fileInfo.classList.add('visible');
            uploadZone.classList.add('has-file');
            uploadText.style.display = 'none';
        } else {
            fileInfo.classList.remove('visible');
            uploadZone.classList.remove('has-file');
            uploadText.style.display = 'block';
            fileInput.value = '';
        }
    }

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            updateFileInfo(e.target.files[0]);
        } else {
            updateFileInfo(null);
        }
    });

    removeFileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        updateFileInfo(null);
    });

    uploadZone.addEventListener('click', () => {
        fileInput.click();
    });

    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.style.borderColor = 'var(--primary)';
        uploadZone.style.background = '#f8fafc';
    });

    uploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadZone.style.borderColor = '#e5e7eb';
        uploadZone.style.background = 'white';
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        const files = e.dataTransfer.files;
        if (files.length) {
            fileInput.files = files;
            updateFileInfo(files[0]);
        }
        uploadZone.style.borderColor = '#e5e7eb';
        uploadZone.style.background = 'white';
    });

    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData();
        if (fileInput.files.length === 0) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
            return;
        }

        formData.append('resume', fileInput.files[0]);

        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Response data:', data);

            let jobsSection = document.querySelector('.jobs-section');
            if (!jobsSection) {
                jobsSection = document.createElement('section');
                jobsSection.className = 'jobs-section';
                uploadForm.after(jobsSection);
            }

            if (data.vacancies && data.vacancies.length > 0) {
                const vacanciesHTML = data.vacancies.map(vacancy => {
                    const similarityScore = vacancy.similarity_score * 100; // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã

                    return `
                        <div class="job-card">
                            <div class="job-info">
                                <h3><a href="${vacancy.url}" target="_blank">${vacancy.title}</a></h3>
                                <div class="company-info">
                                    <div class="company-logo">V</div>
                                    <span>
                                        <p>${vacancy.snippet}</p>
                                    </span>
                                </div>
                                <div class="job-tags">
                                    <span class="tag tag-salary">
                                        ${vacancy.salary ?
                                            `${vacancy.salary.from ? '–æ—Ç ' + vacancy.salary.from + ' ‚ÇΩ' : ''}
                                            ${vacancy.salary.to ? '–¥–æ ' + vacancy.salary.to + ' ‚ÇΩ' : ''}`
                                            : '–ó–∞—Ä–ø–ª–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
                                    </span>
                                    <span class="tag tag-type">${vacancy.employment_type}</span>
                                </div>
                            </div>
                            <div class="similarity-score">
                                <strong>–°—Ö–æ–∂–µ—Å—Ç—å: </strong> ${similarityScore.toFixed(2)}%
                            </div>
                            <a href="${vacancy.url}" class="btn" target="_blank">–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è</a>
                        </div>
                    `;
                }).join('');

                jobsSection.innerHTML = `
                    <div class="jobs-header">
                        <h2 class="jobs-found">–ü–æ–¥—Ö–æ–¥—è—â–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏ (${data.vacancies.length}):</h2>
                    </div>
                    ${vacanciesHTML}
                `;
            } else {
                jobsSection.innerHTML = '<p class="no-vacancies">–ü–æ–¥—Ö–æ–¥—è—â–∏—Ö –≤–∞–∫–∞–Ω—Å–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
            }
        } catch (error) {
            console.error('Error:', error);
            alert(error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
        }
    });
</script>
{% endblock %}
